<h3>Plate {{plate_id}} - {{plate_name}}</h3>
<table class="table">
<tr><th></th>
{% for col in range(len(platemap[0])) %}
  <th>{{ col + 1 }}</th>
{% end %}
</tr>
{% for row_pos, row in enumerate(platemap) %}
  <tr><th>{% raw chr(65 + row_pos) %}</th>
  {% for col_pos, col in enumerate(row) %}
  <td><input type="text" size=12 class="well" id="{{row_pos}}-{{col_pos}}" value="{% raw col.name if col is not None else '' %}" {% if not finalized %}onblur="update(this)"{% else %}disabled{% end %}></td>
  {% end %}
  </tr>
{% end %}
</table>
{% if override %}
<p><input type="checkbox" name="override" id="override"> <label for="override"> Override Sample Check</label></p>

<p style="color: red" id="message"></p>

<div id="dialog-form" title="Create Override Sample">
  <form id="create-sample-form">
      <input type="hidden" name="sample" id="sample-name">
      <table class="Table">
        <tr><td>Sample Name</td><td id='view-sample-name'></td></tr>
        <tr><td>Sample Set</td><td>
        <select name="sample-set" id="sample-set" required>
          <option value=""></option>
          {% for set in sets %}
          <option value="{{set}}">{{set}}</option>
          {% end %}
        </select><br/>
      </td></tr>
      <tr><td>Sample Type</td><td><input type="text" name="type" id="type" required></td></tr>
      <tr><td>Sample Location</td><td><input type="text" name="location" id="location" required></td></tr>
    </table>
  </form>
</div>
{% end %}
{% if not finalized %}
<p><input type="button" value="Finalize" name="finalize" id="finalize" onclick="check_finalize()"></p>
{% end %}

<script type="text/javascript">
{% if not finalized %}
  function check_finalize() {
    if(confirm('Are you sure you want to finalize the plate? You will not be able to add or remove samples once you do so.')) {
      $.post('/plate/update/', { action: 'finalize', plate_id: "{{plate_id}}" })
        .done(function (data) {
          $(".well").each(function (index, elem) {
            var obj = $("#" + elem.id);
            obj.attr("disabled", "disabled");
            obj.prop( "onblur", null );
            $("#finalize").remove();
          });
        });
    }
  }
{% end %}

  var rowcol = null;
  function update(elem) {
    var obj = $("#" + elem.id);
    if(obj.val() === "") { return; }
    rowcol = elem.id;
    $.post('/plate/update/', { action: 'update', plate_id: "{{plate_id}}", rowcol: elem.id, sample: obj.val()})
        .done(function (data) {
          if(data !== "") {
            if($("#override") != null && $("#override").prop('checked')) {
              obj.css("background-color", "yellow");
              clear_override();
              dialog.dialog( "open" );
              $("#sample-name").val(obj.val());
              $("#view-sample-name").text(obj.val());
              $("#message").text("");
            } else {
              fade(obj, "red");
              obj.val("");
              $("#message").css("color", "red");
              $("#message").text(data);
            }
          } else {
            fade(obj, "green");
            $("#message").css("color", "green");
            $("#message").text("Successfully edited " + obj.val());
          }
        });
    }


    function fade(obj, color) {
      obj.css("background", color);
      setTimeout(function(){
          obj.css("background-color", "white"); // reset background
          obj.effect("highlight", {color: color}, 200); // animate
      },200);
    }

  {% if override %}
  function clear_override() {
    $("#sample-name").val("");
    $("#sample-set").val("");
    $("#type").val("");
    $("#location").val("");
    $("#view-sample-name").text("");
  }

  function add_sample(elem) {
    $.post('/sample/add/', $("#create-sample-form").serialize())
      .done(function (data) {
        console.log({ action: 'update', plate_id: "{{plate_id}}", rowcol: rowcol, sample: $("#sample-name").val()});
        $.post('/plate/update/', { action: 'update', plate_id: "{{plate_id}}", rowcol: rowcol, sample: $("#sample-name").val()})
          .done(function(data){
            if(data != "") {
              $("#message").css("color", "red");
              $("#message").text(data);
            } else {
              $("#message").css("color", "green");
              $("#message").text("Added sample " + $("#sample-name").val());
            }
            $("#" + rowcol).css("background-color", "white");
          })
          .fail(function() {
            $("#message").text("Could not add sample " + $("#sample-name").val() + " to plate {{plate_id}}");
          });
      })
      .fail(function () {
        $("#message").text("Could not add sample " + $("#sample-name").val());
      });
  }

  dialog = $( "#dialog-form" ).dialog({
    autoOpen: false,
    height: 400,
    width: 600,
    modal: true,
    buttons: {
      "Add Sample": function () {
        if($("#create-sample-form").valid()) {
          add_sample();
          dialog.dialog( "close" );
          }
      },
      Cancel: function() {
        dialog.dialog( "close" );

      }
    },
    close: function() {
    }
  });

  $(document).ready(function () {
    $("#create-sample-form").validate();
    $("#type").autocomplete({ source: {% raw types %} });
    $("#location").autocomplete({ source: {% raw locations %} });
  });
  {% end %}
</script>